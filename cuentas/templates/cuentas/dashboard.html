{% extends 'cuentas/base.html' %}
{% load static %}

{% block title %}Dashboard - AGL SRL{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="d-flex align-items-center mb-2">
                        <a href="{% url 'main:panel' %}" class="btn btn-outline-secondary btn-sm me-3">
                            <i class="bi bi-arrow-left me-1"></i>Panel Principal
                        </a>
                        <h1 class="h2 mb-0 fw-bold text-dark">
                            <i class="bi bi-people-fill me-2 text-primary"></i>
                            Gestión de Cuentas
                        </h1>
                    </div>
                    <p class="text-muted mb-0">
                        Bienvenido, <strong>{{ user.get_full_name|default:user.username }}</strong>
                        <span class="badge bg-success ms-2">
                            <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>
                            En línea
                        </span>
                    </p>
                </div>
                <div>
                    <a href="{% url 'cuentas:crear_cuenta' %}" class="btn btn-primary">
                        <i class="bi bi-person-plus-fill me-1"></i>
                        Nueva Cuenta
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow h-100 animate__animated animate__fadeInUp">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Total Cuentas</h6>
                            <h2 class="mb-0 fw-bold text-primary" id="total-cuentas">{{ stats.total_cuentas }}</h2>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i> +{{ stats.cuentas_mes_actual }} este mes
                            </small>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-people-fill text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow h-100 animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Cuentas Activas</h6>
                            <h2 class="mb-0 fw-bold text-success">{{ stats.cuentas_activas }}</h2>
                            <small class="text-muted">
                                {{ stats.porcentaje_activas }}% del total
                            </small>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow h-100 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Provincias</h6>
                            <h2 class="mb-0 fw-bold text-info">{{ stats.provincias_con_cuentas }}</h2>
                            <small class="text-muted">
                                de {{ stats.total_provincias }} disponibles
                            </small>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-geo-alt-fill text-info" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow h-100 animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Últ. Actualización</h6>
                            <h6 class="mb-0 fw-bold text-warning">{{ stats.ultima_actualizacion|date:"d/m/Y" }}</h6>
                            <small class="text-muted">
                                {{ stats.ultima_actualizacion|timesince }} atrás
                            </small>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-clock-fill text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Row -->
    <div class="row g-4">
        <!-- Recent Accounts -->
        <div class="col-lg-8">
            <div class="card border-0 shadow h-100">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-clock-history me-2 text-primary"></i>
                            Cuentas Recientes
                        </h5>
                        <a href="{% url 'cuentas:lista_cuentas' %}" class="btn btn-sm btn-outline-primary">
                            Ver todas <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Cuenta</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Provincia</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cuenta in cuentas_recientes %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                                <i class="bi bi-{% if cuenta.tipo_cuenta == 'empresa' %}building{% else %}person{% endif %} text-primary"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">{{ cuenta.nombre_cuenta }}</h6>
                                                <small class="text-muted">{{ cuenta.cuit_dni }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if cuenta.tipo_cuenta == 'empresa' %}info{% else %}secondary{% endif %}">
                                            {% if cuenta.tipo_cuenta == 'empresa' %}
                                                <i class="bi bi-building me-1"></i>Empresa
                                            {% else %}
                                                <i class="bi bi-person me-1"></i>Persona
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if cuenta.activo %}success{% else %}danger{% endif %}">
                                            <i class="bi bi-{% if cuenta.activo %}check-circle{% else %}x-circle{% endif %} me-1"></i>
                                            {% if cuenta.activo %}Activo{% else %}Inactivo{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ cuenta.provincia_nombre|default:'-' }}</td>
                                    <td>
                                        <small class="text-muted">{{ cuenta.fecha_creacion|date:"d/m/Y" }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'cuentas:ver_cuenta' cuenta.id_cuenta %}" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{% url 'cuentas:editar_cuenta' cuenta.id_cuenta %}" class="btn btn-outline-secondary btn-sm">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="bi bi-inbox display-1 text-muted"></i>
                                        <p class="text-muted mt-2">No hay cuentas registradas</p>
                                        <a href="{% url 'cuentas:crear_cuenta' %}" class="btn btn-primary">
                                            <i class="bi bi-plus-circle me-1"></i>Crear primera cuenta
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions & Info -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card border-0 shadow mb-4">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-lightning-charge me-2 text-warning"></i>
                        Acciones Rápidas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'cuentas:crear_cuenta' %}" class="btn btn-primary">
                            <i class="bi bi-person-plus-fill me-2"></i>Nueva Cuenta
                        </a>
                        <a href="{% url 'cuentas:lista_cuentas' %}" class="btn btn-outline-primary">
                            <i class="bi bi-search me-2"></i>Buscar Cuentas
                        </a>
                        <a href="{% url 'admin:index' %}" target="_blank" class="btn btn-outline-secondary">
                            <i class="bi bi-gear-fill me-2"></i>Administración
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- System Info -->
            <div class="card border-0 shadow">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-info-circle me-2 text-info"></i>
                        Información del Sistema
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">
                                    <i class="bi bi-database-fill me-1"></i>Base de Datos
                                </span>
                                <span class="badge bg-success">MySQL</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">
                                    <i class="bi bi-server me-1"></i>Estado Servidor
                                </span>
                                <span class="badge bg-success">
                                    <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>
                                    Online
                                </span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">
                                    <i class="bi bi-shield-check me-1"></i>Versión
                                </span>
                                <span class="text-dark fw-semibold">v1.0.0</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <hr class="my-2">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                Última sincronización: <span id="sync-time">Ahora</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh statistics every 30 seconds
    setInterval(refreshStats, 30000);
    
    // Update sync time
    setInterval(updateSyncTime, 1000);
});

function refreshStats() {
    // This would make an AJAX call to refresh statistics
    console.log('Refreshing stats...');
}

function updateSyncTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('es-ES');
    const syncElement = document.getElementById('sync-time');
    if (syncElement) {
        syncElement.textContent = timeString;
    }
}

function exportarCuentas() {
    Swal.fire({
        title: 'Exportar Cuentas',
        text: '¿Deseas exportar todas las cuentas a CSV?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, exportar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'Exportando...',
                text: 'Generando archivo CSV',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Simulate export process
            setTimeout(() => {
                Swal.fire({
                    title: '¡Exportado!',
                    text: 'El archivo CSV se ha descargado correctamente',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Here you would trigger the actual download
                // window.location.href = '/cuentas/export/csv/';
            }, 2000);
        }
    });
}
</script>
{% endblock %}